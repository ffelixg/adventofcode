data = r"""\.........../..\..../.../......./.....\.................-..............-......./..-................./.\|......
../..|..\..\...........\..........-..|.|...........................|...../..............-.................-../
.|..\................../...........................|..............|...-.................././........./........
......./....\.|................\\....|...\......................../\......|......../..........-........./.....
........................-......................|...\.............-..|..|..........|...........................
.............../-............\....\...............-......\..-.............\./...........|.....................
........./|.|...........................-.........................-.-.......\.........-.......\/....|.........
............-.-.........\........../........|..........||............./.-.....................................
................||.....|................-........\............./.................-....../......|..........\...
........................../\..|.......|........|.|..../../.../.....-.-..-..-..........................\.......
..-.......\..............|.|...........|............./....-...........|......-.......|...........|.|....\.....
.\./.\.....-.................................|.......-|...\..........\.........-./......./...................\
....|.................|..............|..|.\............\\...\......\..................-..................\../|
..........|.....\..............................|.-.\................-................./|............../.......
..\|......./............-...............|...|...-..|................../..../.|.........\..........-.........\.
.|\............../............-/.........\.......\.........../........................./......................
...\..................................................\...|...............\..............\....................
..|........./..........|..........................././..............................................\\.|......
...........-.-..............\..-............-..................|/|..............|..-...../.|................\.
..........|..|.../...........................|....-....../........................-.........|.................
\.....................\............/...........-....................../.\...........-..../..........\.........
........-................\\\.........|/....../\..|..|.-...-..............\.....|..............-.........-.....
..........-........-....|.................-.........................\\...-...\|..|.............../.....\.|....
.............................................................|........\-................-....................\
/......\....|-............./...........|................/...\.........|.....-.............|/...|..|...../.....
|...-.........-....................................././|..\...\..../.......|.......\................../.......
...........-..-........../........................\\...................................\......................
............\.......\\|.|.......-.............|..../........-.....|....|.../.-............./.-........../...|.
...................................-..............\...\....\...|..........|.................../..../.......|..
...-...............|......\|/...............-./..../........................\......../.....................|..
.........................................|....\.\..............\-...\\........\.../...........././............
......|........./.|./.................-...../..--.......|...............-.\......|...................|........
.....-.-..............|............../...................\/......./.....|............|....-...................
...-./..........-..........\...../.......-................./........-............................\....\.......
\.../.....|....................\|...........................\.......\.../../............/.....................
.................-.............-.|/..............-.......\...-..|..|........\..../....../...|.................
.........-.................-..........|..........\...................\............./.................-.....\..
....................|........./......|................/.............|................/.\....|............\..|.
..........................\\..../................./.........../-..||......./.............|--....|........\-.-.
.......-.........|..-......-.....\.......................................\-......./.....\.......\/......\.....
............-.......\.............-....||.-.....................\........../..................................
...|........-......\....|.......-.....|.-......\........./.-....-..................../..|..................\..
....\..-.....\.......\.....................-.........\............/.....-.../......-..................\.......
.......-...........\.../..............\..........\..........-................../....-..|....-.......-.........
..../......|...................../\|......-.......-|.........\......|..../||............\........|............
......\.............|...-..................\...|.............-|..-........|................\..................
|./../.............................-..............|.../.....-......|.....\......./........-.......\...........
.............................|...../......\.................\......-.....|..../................./......./.....
..../................-.-..........\....\...........\......\....|\..................|...../|.......-.........\.
.........../.-.....././..|..................................-..........\................/........../|....|....
.||........\.....\.-....\-........................../............................................-..../.......
.../...\.....-\...........\..........|.\...|\..............|........|........|..\\.../.|............|.........
.......\..-....../......./..................\...../\.-....................|.......\.......-...................
...-..........\/..........-...|..................|..................-.../.............-..............\\..-./..
....\...|..|...........-.........|.............................\....-....../..\......................../...../
.-../..\..........|....|........../.......-......................\..............-.....................-.......
|................/..-...........-.\...-|......./.......\..-.....|....\......../............\..................
../../-\-....................|...........|...|..................-...|...........\.......\.....\.........-/....
......................................-...-................/.....|..-../..\................|./...../.../......
....................../.........\......|.\.../......................\...\.....-....................|..........
.........|.-.......\/...../-......|....-.....-.-...........|..........................|....--.........|.......
........................................-............./....-........|........|||-.....\....................\..
...............|\.............\\..-.....|....................\.....-........................\.....|.......|...
.......|..............................................................................................\.\/\...
.................|..../..................../.......\............|....................|.-........|....\.|......
|...............-.................................\........\...........-...................-................|.
.\.........../....||..............................................|......-.....|......................-.|.....
......././.........../...........\.......-...--./|..-......................\............./.....|...|..........
..\...|............|..|.\..........|../.............-...\............|...................................../..
...................|.-..........-..........|..\...../..../....\.//..........|./...............................
./|...../....../..................-\......|.......|.......\.............|....\............./.|..-...-......../
.|....\........\........-....|........../........-.........\..............................................\...
.....-|..........|....-..................-............................/.|..........\.............../......../.
.........................\.........|.......|./.../.......\........-........................\..-\.../..........
.....\....-\..............-......................-....\..................-............................/.......
.............|...|.............-...\.....|..\................\-..............|.......\........................
.....|............|./..\......................./..../............../......../.......................|-....-...
....|....|.......\..|...../......................................\......................-....|..............|.
.\..../.....-.../.........../................/..\....\............./......\....\............../...............
/|../...................--.......\....../..-./....-.......................\..../|.............\...|..../......
.....-.........-...........-.........|.........................../.............|...-.....-......|.............
............./.......-..../.....|....|............\./....\/.................................../...............
....\.........\................|...-.....-.......................................\........|........../........
............................-...........|...|......../..-......\\...../....................|.....|.........-..
..\./.....-...|-...........\....-....................................\.............-..........\...............
.................|.\/.-....../............-...\.............\..../.\...\........|............-./............./
..\..............|..-\.|.............../...............-\..|../.........................\.....................
....-..........././............/......-........-..........-.....-\................../.........................
....-......\...|......./.................-.........................../.../..../\.......|............./........
...|...\........\............................\..........\|..\.-..................../...........|..-\...|.../..
./.............|.................../..|..|..............|............|.............-...../.|..................
................/....\.........|...................|.....-/..../..\\........\........./....|....-..../.....\..
|..............\......\............................................/......||............|/....\..........|.-..
.............|...........|..........|..............\............\...\.........|...............................
...../....../\....................../............./.................\.-.......|../-...........................
\....................|....|...|.\/............-|...|.........................|.................../../.........
...........\|..|..-...........-...............................-\|............./..................\..........|.
.........-./....\........\.............-........-.|....................|......................../\............
..|...............\......-.........................................................\...././...................
/...|...........-....\.................................\./.......|...../...../.|........-.-.................|.
/..........\......../......|........|......................................../................\....|.......\.\
\..\....-..........//.........................\.....\....................................................\....
......../.............-........................|........................../\.................|................
.........................................|................./.....-.........-......|//.-........//........-..|.
......../.\.../............./........|\.....-..\./...........................-....-........|.\|/............\.
.\.../.....|...../.|.....................-................|..................../..-...\....\..............|...
/.............|./...../..-.........\.|..............|.......|.....|..../...|...\..................-./.........
..........|..............\................\....../.-../..-....|.....|.........-...............................
.............../............|........................../......./.\.....................-...|./.......-.....\..
.................../.......|.|...........\./-./\||.|....|........-...........\......-....-..........-........."""

# data = r""".|...\....
# |.-.\.....
# .....|-...
# ........|.
# ..........
# .........\
# ..../.\\..
# .-.-/..|..
# .|....-|.\
# ..//.|...."""

field = data.splitlines()
field_print = field.copy()
l0 = len(field[0])
l1 = len(field)
assert l0 == l1
state_current = 0, 0, 0, 1
state_current = 0, 3, 1, 0


import sys
sys.getrecursionlimit()
sys.setrecursionlimit(19000)

visited = {}
def calculate_next(state):
    # print(state)
    y, x, dy, dx = state
    if y < 0 or x < 0 or x >= l0 or y >= l1:
        return
    if (y, x) not in visited:
        visited[(y, x)] = {(dy, dx)}
    elif (dy, dx) in visited[(y, x)]:
        return
    else:
        visited[(y, x)].add((dy, dx))

    # l = list(field[y])
    # l[x] = "#"
    # field_print[y] = "".join(l)
    # print("\n".join(field_print))
    # print()
    # print()

    match field[y][x]:
        case ".":
            calculate_next((y + dy, x + dx, dy, dx))
        case "|":
            if dx != 0:
                calculate_next((y + 1, x, 1, 0))
                calculate_next((y - 1, x, -1, 0))
            else:
                calculate_next((y + dy, x + dx, dy, dx))
        case "-":
            if dy != 0:
                calculate_next((y, x + 1, 0, 1))
                calculate_next((y, x - 1, 0, -1))
            else:
                calculate_next((y + dy, x + dx, dy, dx))
        case "/":
            calculate_next((y - dx, x - dy, -dx, -dy))
        case "\\":
            calculate_next((y + dx, x + dy, dx, dy))


calculate_next(state_current)

# print(visited)
print(len(visited))


# part 2


sys.getrecursionlimit()
sys.setrecursionlimit(19000)

cache = {}
from time import sleep
def calculate_next(state):
    # print(state);sleep(0.5)
    y, x, dy, dx = state
    if y < 0 or x < 0 or x >= l0 or y >= l1:
        return []
    if state in cache:
        return cache[state]
    cache[state] = []
    match field[y][x]:
        case ".":
            ret = [state] + calculate_next((y + dy, x + dx, dy, dx))
        case "|":
            if dx != 0:
                ret = ([state]
                + calculate_next((y + 1, x, 1, 0))
                + calculate_next((y - 1, x, -1, 0)))
            else:
                ret = [state] + calculate_next((y + dy, x + dx, dy, dx))
        case "-":
            if dy != 0:
                ret = ([state]
                + calculate_next((y, x + 1, 0, 1))
                + calculate_next((y, x - 1, 0, -1)))
            else:
                ret = [state] + calculate_next((y + dy, x + dx, dy, dx))
        case "/":
            ret = [state] + calculate_next((y - dx, x - dy, -dx, -dy))
        case "\\":
            ret = [state] + calculate_next((y + dx, x + dy, dx, dy))
    cache[state] = ret
    return ret

print(len(cache))
ret = calculate_next(state_current)
print(len(set((y, x) for y, x, _, __ in ret )))

# max_ = []
# for i in range(l0):
#     for j, k in (
#         (l1-1, -1),
#         (0, 1)
#     ):
#         print(field[i][j])
#         state = (i, j, 0, k)
#         ret = calculate_next(state)
#         max_.append(len(set((y, x) for y, x, _, __ in ret )))
# for i in range(l1):
#     for j, k in (
#         (l0-1, -1),
#         (0, 1)
#     ):
#         state = (j, i, k, 0)
#         ret = calculate_next(state)
#         max_.append(len(set((y, x) for y, x, _, __ in ret )))
# print(max_)
# print(max(max_))

max_ = []
for i in range(l0):
    for j, k in (
        (0, 1),
        (l1-1, -1),
    ):
        for state in (
            (i, j, 0, k),
            (j, i, k, 0),
        ):
            ret = calculate_next(state)
            max_.append(len(set((y, x) for y, x, _, __ in ret )))

print(max_)
print(max(max_))


state_current = 0, 0, 0, 1
state_current = 0, 3, 1, 0
ret = calculate_next(state_current)
print(len(set((y, x) for y, x, _, __ in ret )))